<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç•™è¨€æ¿</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Noto Sans TC', sans-serif; background: linear-gradient(135deg, #f0f4f8, #c9d6df); color: #333; line-height: 1.6; padding: 20px; }
        .container { max-width: 1000px; margin: 40px auto; padding: 30px; background-color: #ffffff; border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); }
        h1 { text-align: center; color: #4a90e2; font-weight: 700; margin-bottom: 5px; }
        .subtitle { text-align: center; color: #666; margin-bottom: 30px; font-weight: 300; }
        h2 { border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px; color: #555; font-weight: 500; }
        .post-message { background-color: #f7f9fc; padding: 25px; border-radius: 10px; margin-bottom: 40px; border: 1px solid #e1e8ed; }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 500; color: #555; }
        input[type="text"], textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; transition: border-color 0.3s, box-shadow 0.3s; font-family: inherit; }
        input[type="text"]:focus, textarea:focus { border-color: #4a90e2; box-shadow: 0 0 5px rgba(74, 144, 226, 0.5); outline: none; }
        textarea { resize: vertical; }
        .submit-btn { display: block; width: 100%; padding: 12px; background-color: #4a90e2; color: white; border: none; border-radius: 8px; font-size: 18px; cursor: pointer; transition: background-color 0.3s, transform 0.1s; font-weight: 500; }
        .submit-btn:hover { background-color: #357ae8; }
        .submit-btn:active { transform: translateY(1px); }
        .message-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .message-card { background-color: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); border-left: 5px solid #ff6b6b; transition: transform 0.3s, box-shadow 0.3s; display: flex; flex-direction: column; }
        .message-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); }
        .message-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px dashed #eee; padding-bottom: 5px; }
        .message-name { font-weight: 700; color: #4a90e2; font-size: 1.1em; }
        .message-timestamp { font-size: 0.8em; color: #999; }
        .message-content { flex-grow: 1; margin-bottom: 15px; color: #333; }

        /* LINE æŒ‰éˆ•ç‰¹æœ‰æ¨£å¼ï¼Œè®“ LINE åœ–ç¤ºæ›´æ˜é¡¯ */
        .submit-btn i.fab.fa-line {
            color: #fff;
            margin-right: 8px;
        }

        @media (max-width: 600px) {
            .container { margin: 20px; padding: 20px; }
            .message-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>ç•™è¨€æ¿</h1>
        <p class="subtitle">ç•™ä¸‹ä½ çš„æƒ³æ³•!</p>

        <section class="post-message">
            <h2>ç™¼è¡¨æ–°ç•™è¨€ (LINE ç™»å…¥ç¶å®š)</h2>
            <form id="message-form">
                <div class="input-group">
                    <label for="message">ç•™è¨€å…§å®¹</label>
                    <textarea id="message" rows="4" required placeholder="å¯«ä¸‹ä½ çš„è¨Šæ¯..."></textarea>
                </div>
                
                <button type="submit" class="submit-btn line-login-trigger">
                    <i class="fab fa-line"></i> ä½¿ç”¨ LINE ç™»å…¥ä¸¦ç™¼ä½ˆç•™è¨€
                </button>
            </form>
        </section>

        <section class="messages-list">
            <h2>æ‰€æœ‰ç•™è¨€ (<span id="message-count">0</span>)</h2>
            <div id="messages-container" class="message-grid">
            </div>
        </section>
    </div>

    <script>
        const API_URL = 'https://ibnc1aqskh.execute-api.ap-southeast-2.amazonaws.com/test/messages'; 
        
        // ğŸš¨ é€™æ˜¯çµ¦å¾Œç«¯ Python Lambda ç”¨çš„å¸¸æ•¸ï¼Œæ‚¨ä¸éœ€è¦æ›´æ”¹å®ƒï¼Œä½†è¦ç¢ºä¿ Lambda è£¡ç”¨çš„æ˜¯å°çš„ç¶²å€
        const FRONTEND_URL = '[è«‹æ›¿æ›æˆæ‚¨çš„ç•™è¨€æ¿å…¬é–‹ç¶²å€]'; 

        // --- LINE æˆæ¬Šç›¸é—œå¸¸æ•¸ ---
        const LINE_CHANNEL_ID = '2008410094'; 
        const LINE_CALLBACK_URL = 'https://ibnc1aqskh.execute-api.ap-southeast-2.amazonaws.com/test/line-callback';
        const SCOPE = 'profile'; 

        // æˆæ¬Š URL æ¨£æ¿ï¼šæˆ‘å€‘å°‡ç•™è¨€å…§å®¹ (state) åŠ åˆ°ç¶²å€ä¸­
        const LINE_AUTH_URL = `https://access.line.me/oauth2/v2.1/authorize?response_type=code&client_id=${LINE_CHANNEL_ID}&redirect_uri=${LINE_CALLBACK_URL}&scope=${SCOPE}&state=`;
        // --- çµæŸ LINE å¸¸æ•¸è¨­å®š ---


        document.addEventListener('DOMContentLoaded', () => {
            const messageForm = document.getElementById('message-form');
            const messagesContainer = document.getElementById('messages-container');
            const messageCount = document.getElementById('message-count');
            
            function formatTimestamp(unixTimestamp) {
                const date = new Date(parseInt(unixTimestamp));
                return date.toLocaleString('zh-TW', {
                    year: 'numeric', month: '2-digit', day: '2-digit', 
                    hour: '2-digit', minute: '2-digit'
                });
            }

            function renderMessages(messages) {
                messagesContainer.innerHTML = '';
                
                if (!messages || messages.length === 0) {
                    messageCount.textContent = 0;
                    messagesContainer.innerHTML = '<p style="text-align: center; color: #999;">ç›®å‰é‚„æ²’æœ‰ç•™è¨€å–”ï¼Œå¿«ä¾†ç¬¬ä¸€å€‹ç™¼ä½ˆå§ï¼</p>';
                    return;
                }
                
                messageCount.textContent = messages.length;

                messages.forEach((msg) => {
                    const card = document.createElement('div');
                    card.className = 'message-card';
                    
                    const timestampDisplay = formatTimestamp(msg.messageId);

                    // é€™è£¡çš„ msg.nickname å’Œ msg.content å‡å®šæ‚¨çš„ API æœƒå‚³å›é€™å…©å€‹æ¬„ä½
                    card.innerHTML = `
                        <div class="message-header">
                            <span class="message-name"><i class="fas fa-user-circle"></i> ${msg.nickname}</span>
                            <span class="message-timestamp">${timestampDisplay}</span>
                        </div>
                        <p class="message-content">${msg.content.replace(/\n/g, '<br>')}</p>
                    `;
                    messagesContainer.appendChild(card);
                });
            }

            async function fetchMessages() {
                try {
                    messagesContainer.innerHTML = '<p style="text-align: center; color: #4a90e2;"><i class="fas fa-spinner fa-spin"></i> æ­£åœ¨è¼‰å…¥ç•™è¨€...</p>';
                    
                    const response = await fetch(API_URL, { method: 'GET' });
                    if (!response.ok) throw new Error('Failed to fetch messages from AWS.');
                    
                    const data = await response.json();
                    
                    const messages = data.Items; 
                    
                    renderMessages(messages);

                } catch (error) {
                    console.error("Error loading messages:", error);
                    messagesContainer.innerHTML = '<p style="color: red; text-align: center;">ç„¡æ³•è¼‰å…¥ç•™è¨€è³‡æ–™ã€‚è«‹æª¢æŸ¥ API Gateway è¨­å®šã€‚</p>';
                }
            }

            // --- æœ€çµ‚ç©©å®šç‰ˆï¼šæ¢å¾©åˆ°æœ€åŸºç¤çš„ Web æˆæ¬Šè·³è½‰é‚è¼¯ ---
            messageForm.addEventListener('submit', (e) => {
                e.preventDefault();

                const messageInput = document.getElementById('message');
                const message = messageInput.value.trim();
                
                if (message.length === 0) {
                    alert('ç•™è¨€å…§å®¹ä¸èƒ½ç‚ºç©ºï¼');
                    return;
                }
                
                // 1. å°‡ç•™è¨€å…§å®¹ URL ç·¨ç¢¼å¾Œä½œç‚º state åƒæ•¸
                const encodedMessage = encodeURIComponent(message);
                
                // 2. ç›´æ¥å°å‘ LINE çš„ Web æˆæ¬Šé é¢ï¼Œè®“ LINE å®˜æ–¹è‡ªå·±è™•ç†ç™»å…¥æµç¨‹
                window.location.href = LINE_AUTH_URL + encodedMessage;
            });
            // --- æ›¿æ›çµæŸ ---

            // --- æ–°å¢ï¼šè™•ç† Callback å¾Œçš„çµæœé¡¯ç¤º ---
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('success') === 'true') {
                alert('ç•™è¨€ç™¼ä½ˆæˆåŠŸï¼Œä¸¦å·²ä½¿ç”¨æ‚¨çš„ LINE æš±ç¨±ï¼');
                // æ¸…é™¤ URL ä¸Šçš„åƒæ•¸ï¼Œä¿æŒé é¢ä¹¾æ·¨
                history.replaceState(null, '', window.location.pathname); 
            } else if (urlParams.get('error')) {
                alert('ç•™è¨€ç™¼ä½ˆå¤±æ•—ï¼Œè«‹é‡è©¦ã€‚éŒ¯èª¤ç¢¼: ' + urlParams.get('error'));
                history.replaceState(null, '', window.location.pathname);
            }
            // --- çµæŸæ–°å¢ ---
            
            fetchMessages();

        });
    </script>
</body>
</html>
