<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>留言板</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Noto Sans TC', sans-serif; background: linear-gradient(135deg, #f0f4f8, #c9d6df); color: #333; line-height: 1.6; padding: 20px; }
        .container { max-width: 1000px; margin: 40px auto; padding: 30px; background-color: #ffffff; border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); }
        h1 { text-align: center; color: #4a90e2; font-weight: 700; margin-bottom: 5px; }
        .subtitle { text-align: center; color: #666; margin-bottom: 30px; font-weight: 300; }
        h2 { border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px; color: #555; font-weight: 500; }
        .post-message { background-color: #f7f9fc; padding: 25px; border-radius: 10px; margin-bottom: 40px; border: 1px solid #e1e8ed; }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 500; color: #555; }
        input[type="text"], textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; transition: border-color 0.3s, box-shadow 0.3s; font-family: inherit; }
        input[type="text"]:focus, textarea:focus { border-color: #4a90e2; box-shadow: 0 0 5px rgba(74, 144, 226, 0.5); outline: none; }
        textarea { resize: vertical; }
        .submit-btn { display: block; width: 100%; padding: 12px; background-color: #4a90e2; color: white; border: none; border-radius: 8px; font-size: 18px; cursor: pointer; transition: background-color 0.3s, transform 0.1s; font-weight: 500; }
        .submit-btn:hover { background-color: #357ae8; }
        .submit-btn:active { transform: translateY(1px); }
        .message-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .message-card { background-color: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); border-left: 5px solid #ff6b6b; transition: transform 0.3s, box-shadow 0.3s; display: flex; flex-direction: column; }
        .message-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); }
        .message-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px dashed #eee; padding-bottom: 5px; }
        .message-name { font-weight: 700; color: #4a90e2; font-size: 1.1em; }
        .message-timestamp { font-size: 0.8em; color: #999; }
        .message-content { flex-grow: 1; margin-bottom: 15px; color: #333; }

        @media (max-width: 600px) {
            .container { margin: 20px; padding: 20px; }
            .message-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>留言板</h1>
        <p class="subtitle">留下你的想法!</p>

        <section class="post-message">
            <h2>發表新留言</h2>
            <form id="message-form">
                <div class="input-group">
                    <label for="name">暱稱</label>
                    <input type="text" id="name" placeholder="輸入你的暱稱...">
                </div>
                <div class="input-group">
                    <label for="message">留言內容</label>
                    <textarea id="message" rows="4" required placeholder="寫下你的訊息..."></textarea>
                </div>
                <button type="submit" class="submit-btn">
                    <i class="fas fa-paper-plane"></i> 發佈留言
                </button>
            </form>
        </section>

        <section class="messages-list">
            <h2>所有留言 (<span id="message-count">0</span>)</h2>
            <div id="messages-container" class="message-grid">
            </div>
        </section>
    </div>

    <script>
        const API_URL = 'https://ibnc1aqskh.execute-api.ap-southeast-2.amazonaws.com/test/messages'; 

        document.addEventListener('DOMContentLoaded', () => {
            const messageForm = document.getElementById('message-form');
            const messagesContainer = document.getElementById('messages-container');
            const messageCount = document.getElementById('message-count');
            
            function formatTimestamp(unixTimestamp) {
                const date = new Date(parseInt(unixTimestamp));
                return date.toLocaleString('zh-TW', {
                    year: 'numeric', month: '2-digit', day: '2-digit', 
                    hour: '2-digit', minute: '2-digit'
                });
            }

            function renderMessages(messages) {
                messagesContainer.innerHTML = '';
                
                if (!messages || messages.length === 0) {
                    messageCount.textContent = 0;
                    messagesContainer.innerHTML = '<p style="text-align: center; color: #999;">目前還沒有留言喔，快來第一個發佈吧！</p>';
                    return;
                }
                
                messageCount.textContent = messages.length;

                messages.forEach((msg) => {
                    const card = document.createElement('div');
                    card.className = 'message-card';
                    
                    // 【最終修正B】時間戳來源從 msg.timestamp 改為 msg.messageId
                    const timestampDisplay = formatTimestamp(msg.messageId);

                    // 【最終修正A】顯示的欄位名稱從 msg.name/message 改為 msg.nickname/content
                    card.innerHTML = `
                        <div class="message-header">
                            <span class="message-name"><i class="fas fa-user-circle"></i> ${msg.nickname}</span>
                            <span class="message-timestamp">${timestampDisplay}</span>
                        </div>
                        <p class="message-content">${msg.content.replace(/\n/g, '<br>')}</p>
                    `;
                    messagesContainer.appendChild(card);
                });
            }

            async function fetchMessages() {
                try {
                    messagesContainer.innerHTML = '<p style="text-align: center; color: #4a90e2;"><i class="fas fa-spinner fa-spin"></i> 正在載入留言...</p>';
                    
                    const response = await fetch(API_URL, { method: 'GET' });
                    if (!response.ok) throw new Error('Failed to fetch messages from AWS.');
                    
                    const data = await response.json();
                    
                    console.log("從 API 收到的原始資料:", data);

                    const messages = data.Items; 
                    
                    renderMessages(messages);

                } catch (error) {
                    console.error("Error loading messages:", error);
                    messagesContainer.innerHTML = '<p style="color: red; text-align: center;">無法載入留言資料。請檢查 API Gateway 設定。</p>';
                }
            }

            messageForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const nameInput = document.getElementById('name');
                const messageInput = document.getElementById('message');

                const name = nameInput.value.trim();
                const message = messageInput.value.trim();
                
                if (message.length === 0) {
                    alert('留言內容不能為空！');
                    return;
                }
                
                const submitBtn = document.querySelector('.submit-btn');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 發佈中...';

                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ name: name, message: message }) 
                    });

                    if (!response.ok) throw new Error('API 響應錯誤 ' + response.status);

                    nameInput.value = '';
                    messageInput.value = '';
                    await fetchMessages(); 
                    
                } catch (error) {
                    console.error("Error posting message:", error);
                    alert('留言發佈失敗，請檢查網路或 Lambda/API Gateway 設定。');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> 發佈留言';
                }
            });
            
            fetchMessages();

        });
    </script>
</body>
</html>
